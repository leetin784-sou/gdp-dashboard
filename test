import math
import numpy as np
import streamlit as st

st.set_page_config(page_title="TriageAI Demo", layout="centered")
st.title("TriageAI â€“ Risk + Uncertainty (Demo)")
st.caption("Demo há»— trá»£ phÃ¢n luá»“ng: Ä‘á»‹nh lÆ°á»£ng rá»§i ro nguy ká»‹ch + Ä‘á»™ khÃ´ng cháº¯c cháº¯n. BÃ¡c sÄ© quyáº¿t Ä‘á»‹nh cuá»‘i.")

# ---------- Helpers ----------
def sigmoid(x: float) -> float:
    return 1 / (1 + math.exp(-x))

def risk_model(age, hr, sbp, spo2, rr, avpu_idx, chest_pain, trauma):
    """
    MÃ´ hÃ¬nh demo kiá»ƒu logistic (khÃ´ng pháº£i model y táº¿ tháº­t).
    Tráº£ vá» p = P(nguy ká»‹ch) trong [0,1].
    """
    # Chuáº©n hÃ³a nháº¹ Ä‘á»ƒ á»•n Ä‘á»‹nh
    z = (
        -6.5
        + 0.015 * age
        + 0.020 * max(0, hr - 90)
        + 0.040 * max(0, 100 - sbp)
        + 0.090 * max(0, 95 - spo2)
        + 0.030 * max(0, rr - 18)
        + 0.80 * avpu_idx
        + 0.35 * (1 if chest_pain else 0)
        + 0.45 * (1 if trauma else 0)
    )
    return sigmoid(z)

def uncertainty_bootstrap(age, hr, sbp, spo2, rr, avpu_idx, chest_pain, trauma, n=25, seed=42):
    """
    Uncertainty demo: bootstrap/jitter nhiá»u láº§n vÃ  láº¥y Ä‘á»™ lá»‡ch chuáº©n dá»± Ä‘oÃ¡n.
    u cÃ ng cao => mÃ´ hÃ¬nh cÃ ng "khÃ´ng cháº¯c".
    """
    rng = np.random.default_rng(seed)
    ps = []
    for _ in range(n):
        # jitter nhá» quanh Ä‘o Ä‘áº¡c (demo)
        age_j  = age  + rng.normal(0, 1.5)
        hr_j   = hr   + rng.normal(0, 4.0)
        sbp_j  = sbp  + rng.normal(0, 4.0)
        spo2_j = spo2 + rng.normal(0, 1.0)
        rr_j   = rr   + rng.normal(0, 2.0)

        p = risk_model(age_j, hr_j, sbp_j, spo2_j, rr_j, avpu_idx, chest_pain, trauma)
        ps.append(p)
    ps = np.array(ps)
    return float(ps.mean()), float(ps.std())

def triage_decision(risk, u, red_flag):
    """
    Quy táº¯c Human-in-the-loop:
    - Náº¿u cÃ³ red flag => Æ°u tiÃªn Äá» ngay (cáº£nh bÃ¡o máº¡nh)
    - Náº¿u khÃ´ng: dÃ¹ng Risk + Uncertainty Ä‘á»ƒ gá»£i Ã½
    """
    if red_flag:
        return "ğŸ”´ Äá» (Red flag)", "Cáº£nh bÃ¡o ngay theo luáº­t y khoa (red flag)."

    # Gá»£i Ã½ theo risk
    if risk >= 0.70:
        base = "ğŸ”´ Äá»"
    elif risk >= 0.30:
        base = "ğŸŸ¡ VÃ€NG"
    else:
        base = "ğŸŸ¢ XANH"

    # Äiá»u chá»‰nh thÃ´ng Ä‘iá»‡p theo uncertainty
    if u >= 0.20:
        note = "âš ï¸ Uncertainty CAO: khuyáº¿n nghá»‹ bÃ¡c sÄ© Ä‘Ã¡nh giÃ¡ ká»¹ trÆ°á»›c khi chá»‘t."
    elif u >= 0.10:
        note = "Uncertainty TRUNG BÃŒNH: nÃªn kiá»ƒm tra thÃªm dáº¥u hiá»‡u/khai thÃ¡c."
    else:
        note = "Uncertainty THáº¤P: mÃ´ hÃ¬nh khÃ¡ tá»± tin."

    return base, note

# ---------- UI ----------
st.subheader("Nháº­p dá»¯ liá»‡u lÃ¢m sÃ ng ban Ä‘áº§u")

col1, col2 = st.columns(2)
with col1:
    age = st.number_input("Tuá»•i", 0, 120, 40)
    hr = st.number_input("Máº¡ch (HR, bpm)", 30, 220, 90)
    sbp = st.number_input("Huyáº¿t Ã¡p tÃ¢m thu (SBP, mmHg)", 50, 220, 120)
with col2:
    spo2 = st.number_input("SpOâ‚‚ (%)", 50, 100, 98)
    rr = st.number_input("Nhá»‹p thá»Ÿ (RR, /phÃºt)", 5, 60, 18)
    avpu = st.selectbox("Tri giÃ¡c (AVPU)", ["A (tá»‰nh)", "V (Ä‘Ã¡p á»©ng lá»i)", "P (Ä‘Ã¡p á»©ng Ä‘au)", "U (khÃ´ng Ä‘Ã¡p á»©ng)"])

st.subheader("Triá»‡u chá»©ng / bá»‘i cáº£nh (tuá»³ chá»n)")
c1, c2, c3 = st.columns(3)
with c1:
    chest_pain = st.checkbox("Äau ngá»±c")
with c2:
    trauma = st.checkbox("Cháº¥n thÆ°Æ¡ng")
with c3:
    severe_dyspnea = st.checkbox("KhÃ³ thá»Ÿ náº·ng (cáº£m nháº­n)")

# Red flags (luáº­t y khoa Ä‘Æ¡n giáº£n Ä‘á»ƒ demo)
avpu_idx = ["A (tá»‰nh)", "V (Ä‘Ã¡p á»©ng lá»i)", "P (Ä‘Ã¡p á»©ng Ä‘au)", "U (khÃ´ng Ä‘Ã¡p á»©ng)"].index(avpu)
red_flag = (spo2 < 90) or (sbp < 90) or (avpu_idx >= 2) or severe_dyspnea

st.divider()

if st.button("ÄÃ¡nh giÃ¡ Risk + Uncertainty", type="primary"):
    mean_p, u = uncertainty_bootstrap(age, hr, sbp, spo2, rr, avpu_idx, chest_pain, trauma)
    risk = mean_p  # dÃ¹ng mean probability lÃ m risk

    triage, note = triage_decision(risk, u, red_flag)

    st.subheader("Káº¿t quáº£")
    st.metric("Risk score (P nguy ká»‹ch)", f"{risk*100:.1f}%")
    st.metric("Uncertainty (Ä‘á»™ khÃ´ng cháº¯c cháº¯n)", f"{u:.3f}")

    if "ğŸ”´" in triage:
        st.error(f"**Gá»£i Ã½ phÃ¢n luá»“ng:** {triage}\n\n{note}")
    elif "ğŸŸ¡" in triage:
        st.warning(f"**Gá»£i Ã½ phÃ¢n luá»“ng:** {triage}\n\n{note}")
    else:
        st.success(f"**Gá»£i Ã½ phÃ¢n luá»“ng:** {triage}\n\n{note}")

    st.caption("LÆ°u Ã½: ÄÃ¢y lÃ  demo phá»¥c vá»¥ thuyáº¿t trÃ¬nh/Ã½ tÆ°á»Ÿng. KhÃ´ng dÃ¹ng Ä‘á»ƒ cháº©n Ä‘oÃ¡n hoáº·c quyáº¿t Ä‘á»‹nh lÃ¢m sÃ ng tháº­t.")
